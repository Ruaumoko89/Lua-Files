function get_sets()
    sets.precast = {}
    sets.precast.JA = {}
    
    -- Precast Sets
    sets.precast.JA.Nightingale = {feet="Bihu Slippers +3"}
    
    sets.precast.JA.Troubadour = {body="Bihu Justaucorps +3"}
    
    sets.precast.JA['Soul Voice'] = {legs="Bihu Cannions +3"}
    
    sets.precast.FC = {}
    
    sets.precast.FC.Song = {main="Kali",sub="Chanter's Shield",range="",ammo=empty,
    head="Fili Calot +1",neck="Baeytl Pendant",ear1="Etiolation Earring",ear2="Loquac. Earring",
    body="Inyanga Jubbah +2",hands="Leyline Gloves",ring1="Kishar Ring",ring2="Rahab Ring",
	back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}}, waist="Witful belt",legs="Ayanmo Cosciales +2",feet="Bihu Slippers +3"}
        
    sets.precast.FC.Normal = {head="Nahtirah Hat",neck="Baeytl Pendant",ear1="Etiolation Earring",ear2="Loquacious Earring",
		body="Inyanga Jubbah +2",hands="Leyline Gloves",ring1="Rahab Ring",ring2="Kishar Ring",
		back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}},waist="Witful Belt",legs="Ayanmo Cosciales +2",feet="Vanya Clogs"}
        
    sets.precast.EnhancingMagic = {head="Nahtirah Hat",neck="Baeytl Pendant",ear1="Etiolation Earring",ear2="Loquacious Earring",
		body="Inyanga Jubbah +2",hands="Leyline Gloves",ring1="Rahab Ring",ring2="Kishar Ring",
		back="Intarabus's Cape",waist="Witful Belt",legs="Lengo Pants",feet="Chelona Boots"}
	
		sets.precast.Cure = {head="Nahtirah Hat",neck="Baeytl Pendant",ear1="Etiolation Earring",ear2="Loquacious Earring",
		body="Inyanga Jubbah +2",hands="Leyline Gloves",ring1="Rahab Ring",ring2="Kishar Ring",
		back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}},waist="Witful Belt",legs="Ayanmo Cosciales +2",feet="Vanya Clogs"}
    
    sets.precast.WS = {}
    sets.MordantRime= {range="Linos", 
	head="Bihu Roundlet +3",
    body="Bihu Justaucorps +3",
    hands="Bihu Cuffs +3",
    legs="Bihu Cannions +3",
    feet="Bihu Slippers +3",
    neck="Bard's Charm +1",
    waist="Grunfeld Rope",
    left_ear="Moonshade Earring",
    right_ear="Telos Earring",
    left_ring="Shukuyu Ring",
    right_ring="Ilabrat Ring",
    back={ name="Intarabus's Cape", augments={'CHR+20','Accuracy+20 Attack+20','Weapon skill damage +10%',}},
}
	
	
	    sets.precast.WS = {}
    sets.Rudra = {range="Linos", 
	head="Lustratio Cap +1",
    body="Bihu Justaucorps +3",
    hands="Lustratio Mittens +1",
    legs="Lustratio Subligar +1",
    feet="Lustratio Leggings +1",
    neck="Bard's Charm +1",
    waist="Grunfeld Rope",
    left_ear="Moonshade Earring",
    right_ear="Ishvara Earring",
    left_ring="Petrov Ring",
    right_ring="Ilabrat Ring",
    back={ name="Intarabus's Cape", augments={'DEX+20','Accuracy+20 Attack+20','Weapon skill damage +10%',}},
}

	    sets.precast.WS = {}
    sets.Evisceration = {head="Lustratio Cap +1",
    body="Ayanmo Corazza +2",
    hands="Lustratio Mittens +1",
    legs="Lustratio Subligar +1",
    feet="Lustratio Leggings +1",
    neck="Bard's Charm +1",
    waist="Fotia Belt",
    left_ear="Moonshade Earring",
    right_ear="Telos Earring",
    left_ring="Begrudging Ring",
    right_ring="Ilabrat Ring",
    back={ name="Intarabus's Cape", augments={'DEX+20','Accuracy+20 Attack+20','Crit.hit rate+10',}},
}
	
        sets.precast.WS = {}
    sets.Savage = {range="Linos",
	head="Lustratio Cap +1",
    body="Bihu Justaucorps +3",
    hands="Bihu Cuffs +3",
    legs="Bihu Cannions +3",
    feet="Lustratio Leggings +1",
    neck="Caro Necklace",
    waist="Metalsinger Belt",
    left_ear="Moonshade Earring",
    right_ear="Ishvara Earring",
    left_ring="Petrov Ring",
    right_ring="Rufescent Ring",
    back={ name="Intarabus's Cape", augments={'STR+20','Accuracy+20 Attack+20','Weapon skill damage +10%',}},
}
		
	sets.TP = {}
    sets.TP = {range="Linos",
	head="Bihu Roundlet +3",
    body="Ashera Harness",
    hands="Bihu Cuffs +3",
    legs="Bihu Cannions +3",
    feet="Bihu Slippers +3",
    neck="Bard's Charm +1",
    waist="Sarissapho. Belt",
    left_ear="Dedition Earring",
    right_ear="Telos Earring",
    left_ring="Chirich Ring +1",
    right_ring="Ilabrat Ring",
    back={ name="Intarabus's Cape", augments={'DEX+20','Accuracy+20 Attack+20','Accuracy+10','"Dual Wield"+10','Phys. dmg. taken-10%',}},
}
	
    
    -- Midcast Sets
    sets.midcast = {}
        
    sets.midcast.Haste = {head="Telchine Cap",neck="Baeytl Pendant",ear1="Etiolation Earring",ear2="Loquacious Earring",
		body="Telchine Chasuble",hands="Telchine Gloves",ring1="Rahab Ring",ring2="Kishar Ring",
		back="Intarabus's Cape",waist="Witful Belt",legs="Telchine Braconi",feet="Telchine Pigaches"}	
		
    sets.midcast.Debuff ={range="Gjallarhorn",
	sub="Ammurapi Shield",
    head="Bihu Roundlet +3",
    body="Brioso Justaucorps +2",
    hands="Inyanga Dastanas +2",
    legs="Bihu Cannions +3",
    feet="Brioso Slippers +3",
    neck="Moonbow Whistle +1",
    waist="Luminary Sash",
    left_ear="Regal Earring",
    right_ear="Dignitary's Earring",
    left_ring="Stikini Ring",
    right_ring="Stikini Ring",
    back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}},
}


    sets.midcast.Threnody= { main="Kali",sub="Ammurapi Shield",
    range="Gjallarhorn",
    head="Bihu Roundlet +3",
    body="Brioso Justaucorps +2",
    hands="Inyanga Dastanas +2",
    legs="Bihu Cannions +3",
    feet="Brioso Slippers +3",
    neck="Moonbow Whistle +1",
    waist="Luminary Sash",
    left_ear="Regal Earring",
    right_ear="Dignitary's Earring",
    left_ring="Stikini Ring",
    right_ring="Stikini Ring",
    back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}},
}

    
    sets.midcast.Buff = {main="Kali",sub="Genmei shield",head="Bihu Roundlet +3",neck="Moonbow Whistle +1", left_ring="Stikini Ring", right_ring="Stikini Ring", waist="Witful Belt",
	    back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}},
        body="Fili Hongreline +1",hands="Fili Manchettes +1",legs="Inyanga Shalwar +2",feet="Brioso Slippers +3"}
		
    sets.midcast.Carol = {main="Kali",sub="Genmei shield",head="Fili Calot +1",neck="Moonbow Whistle +1", left_ring="Stikini Ring", right_ring="Stikini Ring", waist="Witful Belt",
	    back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}},
        body="Fili Hongreline +1",hands="Fili Manchettes +1",legs="Inyanga Shalwar +2",feet="Brioso Slippers +3"}
		
	sets.midcast.Cure = {main="Daybreak",sub="Ammurapi Shield",head="Kaykaus Mitra +1",neck="Incanter's Torque",ear1="Gifted Earring",ear2="Magnetic Earring",
		body="Kaykaus Bliaut +1",hands="Kaykaus Cuffs +1",ring1="Janniston Ring",ring2="Kuchekula Ring",
	    back="Thaumaturge's Cape",waist="Luminary Sash",legs="Kaykaus Tights +1",feet="Kaykaus Boots +1"}		
		
		
	sets.midcast.Marsyas = {range="Marsyas",main="Kali",sub="Genmei shield",head="Bihu Roundlet +3",neck="Moonbow Whistle +1",
        body="Fili Hongreline +1",hands="Fili Manchettes +1",legs="Inyanga Shalwar +2",waist="Luminary sash",feet="Brioso Slippers +3", 
		back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}},}	
    
	sets.midcast.Lullaby = {range="Blurred Harp +1",head="Bihu Roundlet +3",neck="Moonbow Whistle +1", left_ear="Regal Earring", right_ear="Dignitary's Earring",
       body="Fili Hongreline +1",hands="Brioso Cuffs +3",legs="Inyanga Shalwar +2",feet="Brioso Slippers +3", 
		back={ name="Intarabus's Cape", augments={'CHR+20','Mag. Acc+20 /Mag. Dmg.+20','Mag. Acc.+10','"Fast Cast"+10',}},}
	
    sets.midcast.GBuff = {range="Gjallarhorn",ammo=empty}
	   
    sets.midcast.Duration = {body="Fili Hongreline +1",neck="Moonbow Whistle +1",legs="Inyanga Shalwar +2",feet="Brioso Slippers +3"}
        
    sets.midcast.Scherzo = {feet="Fili Cothurnes +1"}
	
	sets.midcast.Dirge = {hands="Bihu Cuffs +1"}
	
	sets.midcast.Etude = {head="Mousai Turban +1"}
	
	sets.midcast.Mambo = {feet="Mousai Crackows"}
	
	sets.midcast.Carol = {hands="Mousai Gages +1"}
	
	sets.midcast.Sirvente = {head="Bihu Roundlet +3"}
        
    sets.midcast.Paeon = {range="Daurdabla"}
	
	sets.midcast.Madrigal = {head="Fili Calot +1"}
	
	sets.midcast.Minne = {legs="Mousai Seraweels +1"}
       
    sets.midcast.Base = sets.midcast.Haste
    
    sets.midcast.Waltz = {}
        
        
    sets.midcast.Stoneskin = {main="Kali", sub="Ammurapi shield",head={ name="Telchine Cap", augments={'Enh. Mag. eff. dur. +9',}},
    body={ name="Telchine Chas.", augments={'Enh. Mag. eff. dur. +7',}},
    hands={ name="Telchine Gloves", augments={'Enh. Mag. eff. dur. +10',}},
    legs={ name="Telchine Braconi", augments={'Enh. Mag. eff. dur. +9',}},
    feet={ name="Telchine Pigaches", augments={'Enh. Mag. eff. dur. +7',}},
    neck="Nodens gorget",
    waist="Witful belt",
    left_ear="Enchanter's Earring +1",
    right_ear="Loquac. Earring",
    left_ring="Rahab ring",
    right_ring="Kishar Ring",
	back="Intarabus's Cape",}		
	
	sets.midcast.Haste = {main="Kali", sub="Ammurapi shield",
	head="Telchine Cap", 
    body="Telchine Chas.",
    hands="Telchine Gloves",
    legs="Telchine Braconi",
    feet="Telchine Pigaches",
    neck="Nodens gorget",
    waist="Witful belt",
    left_ear="Enchanter's Earring +1",
    right_ear="Loquac. Earring",
    left_ring="Rahab ring",
    right_ring="Kishar Ring",
	back="Intarabus's Cape",}	
		
    
    
    --Aftercast Sets
    sets.aftercast = {}
    sets.aftercast.Regen = {main="Daybreak",sub="Genmei Shield",range="Marsyas",ammo=empty,
	head="Bihu Roundlet +3",
    body="Bihu Justaucorps +3",
    hands="Bihu Cuffs +3",
    legs="Bihu Cannions +3",
    feet="Fili Cothurnes +1",
    neck="Loricate Torque +1",
    waist="Flume Belt",
    left_ear="Etiolation Earring",
    right_ear="Gifted Earring",
    left_ring="Gelatinous Ring +1",
    right_ring="Defending Ring",
    back="Moonbeam Cape",
}
    
    sets.aftercast.PDT = {main="Daybreak",sub="Genmei shield",range="Marsyas",ammo=empty,
    head="Aya. Zucchetto +1",
    body="Ayanmo Corazza +1",
    hands="Aya. Manopolas +1",
    legs="Aya. Cosciales +1",
    feet="Fili cothurnes +1",
    neck="Bard's Charm +1",
    waist="Flume Belt",
    left_ear="Mendi. Earring",
    right_ear="Genmei Earring",
    left_ring="Shneddick Ring",
    right_ring="Defending Ring",
    back="Mecistopins mantle",
}
    
    sets.aftercast.Engaged = {range="Linos",
	head="Bihu Roundlet +3",
    body="Bihu Justaucorps +3",
    hands="Bihu Cuffs +3",
    legs="Bihu Cannions +3",
    feet="Bihu Slippers +3",
    neck="Bard's Charm +1",
    waist="Sarissapho. Belt",
    left_ear="Dedition Earring",
    right_ear="Telos Earring",
    left_ring="Chirich Ring +1",
    right_ring="Chirich Ring +1",
    back={ name="Intarabus's Cape", augments={'DEX+20','Accuracy+20 Attack+20','Accuracy+10','"Dual Wield"+10','Phys. dmg. taken-10%',}},
}
        
    sets.aftercast._tab = {'Regen','PDT'}
    
    sets.aftercast._index = 1
    
    sets.aftercast.Idle = sets.aftercast[sets.aftercast._tab[sets.aftercast._index]]
	
    send_command('input /macro book 14;wait .1;input /macro set 2')
    timer_reg = {}
    pianissimo_cycle = false
end

function pretarget(spell)
    if spell.type == 'BardSong' and spell.target.type and spell.target.type == 'PLAYER' and not buffactive.pianissimo and not spell.target.charmed and not pianissimo_cycle then
        cancel_spell()
        pianissimo_cycle = true
        send_command('input /ja "Pianissimo" <me>;wait 1.5;input /ma "'..spell.name..'" '..spell.target.name..';')
        return
    end
    if spell.name ~= 'Pianissimo' then
        pianissimo_cycle = false
    end
end

function precast(spell)
        if spell.type=="BardSong" then
                equip(sets.precast.FC.Song)		
                if buffactive["Nightingale"] then
		            if spell.english=="Honor March" then
				        equip(sets.midcast.Buff,sets.midcast.Marsyas)	
					else
                        equip_song_gear(spell)					
					end	
			    end	
        elseif spell.action_type=="Magic" then
                equip(sets.precast.FC.Normal)
        end
        if spell.action_type=="Magic" then
                if sets.precast.FC[tostring(spell.element)] then
                        equip(sets.precast.FC[tostring(spell.element)])
                end
        end
        if sets.precast.JA[spell.name] then
                equip(sets.precast.JA[spell.name])
        end
		
			if spell.english == 'Mordant Rime' then
		equip(sets.MordantRime)
		send_command('')	
		
		elseif spell.english == "Rudra's Storm" then
		equip(sets.Rudra)
		send_command('')	
		
		elseif spell.english == 'Evisceration' then
		equip(sets.Evisceration)
		send_command('')	
		
		elseif spell.english == "Savage Blade" then
		equip(sets.Savage)
		send_command('')	
		end
end

function midcast(spell)
        if spell.type=="BardSong" then
		    if spell.english=="Honor March" then
				equip(sets.midcast.Buff,sets.midcast.Marsyas)	
			else
                equip_song_gear(spell)	
            if spell.name=="Ice Threnody II" then
                equip({waist="Chaac belt"})		
			end	
			end
        elseif string.find(spell.name,"Cure") or string.find(spell.name,"Curaga") then
                equip(sets.midcast.EnmityRecast,sets.midcast.Cure)
        elseif spell.name=="Cursna" then
                equip(sets.midcast.EnmityRecast,sets.midcast.Cursna)
		 elseif spell.name=="Haste" then
                equip(sets.midcast.EnmityRecast,sets.midcast.Stoneskin)		
        elseif spell.name=="Stoneskin" then
                equip(sets.midcast.EnmityRecast,sets.midcast.Stoneskin)
                        if buffactive["Stoneskin"] then
                                windower.send_command('wait 1;cancel 37;')
                        end
        elseif string.find(spell.name,"Protect") or string.find(spell.name,"Shell") then
                equip(sets.midcast.EnmityRecast,sets.midcast.ProShell)
        elseif spell.name=="Sneak" and buffactive["Sneak"] and spell.target.type=="SELF" then
                windower.send_command('cancel 71;')
        elseif spell.type=="Ninjutsu" then
                if spell.name=="Utsusemi: Ichi" then
                        equip(sets.aftercast.PDT)
                                if buffactive["Copy Image"] then
                                        windower.send_command('wait 1;cancel 66;')
                                end
                else
                        equip(sets.aftercast.PDT)
                end
        elseif spell.action_type=="Magic" then
                equip(sets.midcast.EnmityRecast)
		end		
end

function aftercast(spell)
    if midaction() then return end
--[[    if spell.type and spell.type == 'BardSong' and spell.target and spell.target.type:upper() == 'SELF' then
        local t = os.time()
        
        -- Eliminate songs that have already expired
        local tempreg = {}
        for i,v in pairs(timer_reg) do
            if v < t then tempreg[i] = true end
        end
        for i,v in pairs(tempreg) do
            timer_reg[i] = nil
        end
        
        local dur = calculate_duration(spell.name)
        if timer_reg[spell.name] then
            if (timer_reg[spell.name] - t) <= 120 then
                send_command('timers delete "'..spell.name..'"')
                timer_reg[spell.name] = t + dur
                send_command('timers create "'..spell.name..'" '..dur..' down')
            end
        else
            local maxsongs = 2
            if player.equipment.range == 'Terpander' then
                maxsongs = maxsongs+2
            end
            if buffactive['Clarion Call'] then
                maxsongs = maxsongs+1
            end
            if maxsongs < table.length(timer_reg) then
                maxsongs = table.length(timer_reg)
            end
            
            if table.length(timer_reg) < maxsongs then
                timer_reg[spell.name] = t+dur
                send_command('timers create "'..spell.name..'" '..dur..' down')
            else
                local rep,repsong
                for i,v in pairs(timer_reg) do
                    if t+dur > v then
                        if not rep or rep > v then
                            rep = v
                            repsong = i
                        end
                    end
                end
                if repsong then
                    timer_reg[repsong] = nil
                    send_command('timers delete "'..repsong..'"')
                    timer_reg[spell.name] = t+dur
                    send_command('timers create "'..spell.name..'" '..dur..' down')
                end
            end
        end
    end]]
    if player.status == 'Engaged' then
        equip(sets.TP)
    else
        equip(sets.aftercast.Idle)
    end
end



function status_change(new,old)
    if new == 'Engaged' then
        equip(sets.TP)
        disable('main','sub','ammo')
    elseif T{'Idle','Resting'}:contains(new) then
        equip(sets.aftercast.Idle)
    end
end

function self_command(cmd)
    if cmd == 'unlock' then
        enable('main','sub','ammo')
    elseif cmd == 'midact' then
        midaction(false)
    elseif cmd == 'idle' then
        sets.aftercast._index = sets.aftercast._index%(#sets.aftercast._tab) + 1
        windower.add_to_chat(8,'Aftercast Set: '..sets.aftercast._tab[sets.aftercast._index])
        sets.aftercast.Idle = sets.aftercast[sets.aftercast._tab[sets.aftercast._index]]
        equip(sets.aftercast.Idle)
    end
end

function equip_song_gear(spell)
        if spell.target.type == 'MONSTER' then
            equip(sets.midcast.Base,sets.midcast.Debuff,sets.midcast.GBuff)
            if buffactive.troubadour or buffactive['elemental seal'] then
                equip(sets.midcast.Duration)
            end
            if string.find(spell.english,'Lullaby') then equip(sets.midcast.Duration,sets.midcast.Lullaby) end
        else
            equip(sets.midcast.Base,sets.midcast.Buff,sets.midcast.GBuff)
            if string.find(spell.english,'Ballad') then equip(sets.midcast.Ballad) end
			if string.find(spell.english,'Madrigal') then equip(sets.midcast.Madrigal) end
			if string.find(spell.english,'Dirge') then equip(sets.midcast.Dirge) end
			if string.find(spell.english,'Sirvente') then equip(sets.midcast.Sirvente) end
			if string.find(spell.english,'Mambo') then equip(sets.midcast.Mambo) end
			if string.find(spell.english,'Carol') then equip(sets.midcast.Carol) end
            if string.find(spell.english,'Scherzo') then equip(sets.midcast.Scherzo) end
            if string.find(spell.english,'Paeon') then equip(sets.midcast.Paeon) end
			if string.find(spell.english,'Minne') then equip(sets.midcast.Minne) end
			if string.find(spell.english,'Etude') then equip(sets.midcast.Etude) end
        end
    end

function calculate_duration(name)
    local mult,ext = 1,0
    if player.equipment.range == 'Marsyas' then mult = mult + 1.0 end
    if player.equipment.range == "Gjallarhorn" then mult = mult + 0.4 end
    if player.equipment.neck == "Moonbow Whistle" then mult = mult + 0.1 end
    if player.equipment.feet == "Brioso Slippers" then mult = mult + 0.1 end
    if player.equipment.body == "Fili Hongreline +1" then mult = mult + 0.1 end
    if player.equipment.legs == "Inyanga Shalwar +2" then mult = mult + 0.1 end
    if player.equipment.main == "Kali" then mult = mult + 1.0 end
    
    if string.find(name,'March') and player.equipment.hands == 'Fili Manchettes +1' then mult = mult + 0.1 end
    if string.find(name,'Minuet') and player.equipment.body == "Fili Hongreline +1" then mult = mult + 0.1 end
    if string.find(name,'Madrigal') and player.equipment.head == "Fili Calot +1" then mult = mult + 0.1 end
    if string.find(name,'Ballad') and player.equipment.legs == "Fili Rhingrave +1" then mult = mult + 0.1 end
    if string.find(name,'Scherzo') and player.equipment.feet == "Fili Cothurnes +1" then mult = mult + 0.1 end
    if string.find(name,'Paeon') and player.equipment.head == "Bihu Roundlet +1" then mult = mult + 0.1 end
	if string.find(name,'Dirge') and player.equipment.hands == 'Bihu Cuffs +1' then mult = mult + 0.1 end
    if string.find(name,'Sirvente') and player.equipment.head == 'Bihu Roundlet +1' then mult = mult + 0.1 end
	
    if buffactive.Troubadour then
        mult = mult*2
    end
    if string.find(name,'Scherzo') and buffactive['Soul Voice'] then
        mult = mult*2
    elseif string.find(name,'Scherzo') and buffactive.marcato then
        mult = mult*1.5
    end
    
    if buffactive['Clarion Call'] then
        ext = 20
    end
    
    return mult*120 + ext
end

function reset_timers()
    for i,v in pairs(timer_reg) do
        send_command('timers delete "'..i..'"')
    end
    timer_reg = {}
end

windower.register_event('zone change',reset_timers)
windower.register_event('logout',reset_timers)